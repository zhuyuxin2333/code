/*
 * Copyright (c) 2006-2024, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2024-07-06     RT-Thread    first version
 */

#include <rtthread.h>
#include <rtdevice.h>
#define DBG_TAG "main"
#define DBG_LVL DBG_LOG
#include <rtdbg.h>
#include <string.h>
#include <board.h>
#include <drv_common.h>
#define SAMPLE_UART_NAME       "uart4"
rt_device_t Uart4;
struct serial_configure Uart4_config;
rt_thread_t  thread1 = RT_NULL;
struct rt_semaphore sem;
rt_uint8_t send_data[] = {0xAA};
rt_uint8_t send_data_1[] = {0x04};
rt_uint8_t send_data_2[] = {0x80};
rt_uint8_t send_data_3[] = {0x02};
rt_uint8_t send_data_4;
rt_uint8_t send_data_5;


rt_int16_t data[] = {
                      -113, -185, -102, 21, 13, -141, -273, -166, 5, 25, -84, -151, -107, 7, 56,
                      -44, -196, -157, -10, 10, -101, -189, -153, 6, 139, 108, -33, -38, 153, 310,
                      277, 165, 138, 230, 340, 312, 133, 27, 128, 220, 138, -43, -139, -88, 18, 9,
                      -147, -298, -227, -71, -49, -149, -216, -196, -75, 16, -59, -216, -198, -13,
                      87, 26, -33, 16, 167, 285, 261, 117, 88, 268, 394, 327, 201, 182, 298, 438,
                      441, 285, 144, 208, 336, 338, 225, 148, 171, 269, 304, 181, 18, 66, 228, 269,
                      160, 66, 83, 202, 269, 172, -5, -10, 147, 192, 57, -49, -17, 113, 201, 138,
                      -22, -56, 138, 338, 353, 258, 230, 329, 492, 547, 432, 298, 394, 587, 641,
                      536, 456, 500, 637, 685, 564, 400, 429, 594, 634, 507, 406, 435, 563, 644,
                      587, 454, 428, 570, 650, 563, 432, 372, 413, 475, 407, 199, 48, 123, 224,
                      156, -22, -131, -110, -34, -60, -252, -474, -470, -341, -325, -429, -498,
                      -476, -385, -328, -409, -568, -561, -374, -264, -341, -439, -429, -311, -190,
                      -187, -326, -396, -268, -157, -204, -308, -328, -253, -135, -115, -230, -314,
                      -181, -11, -20, -161, -252, -228, -93, -40, -154, -327, -297, -140, -99, -206,
                      -313, -300, -181, -120, -235, -429, -425, -232, -121, -183, -273, -266, -147,
                      -23, -44, -211, -293, -161, -14, -37, -154, -204, -130, 18, 51, -82, -215,
                      -133, 34, 55, -75, -181, -170, -40, 29, -69, -237, -211, -20, 49, -56, -168,
                      -166, -73, -25, -126, -323, -398, -299, -243, -346, -484, -534, -483, -394,
                      -433, -599, -718, -620, -487, -532, -693, -770, -724, -626, -646, -849, -1070,
                      -1094, -1010, -1035, -1176, -1269, -1278, -1228, -1221, -1303, -1383, -1385,
                      -1350, -1329, -1305, -1267, -1220, -1173, -1127, -1083, -1044, -1002, -964,
                      -925, -890, -856, -823, -791, -760, -730, -701, -675, -647, -621, -598, -573,
                      -551, -530, -507, -487, -468, -449, -429, -412, -394, -378, -363, -347, -332,
                      -316, -305, -292, -276, -258, -235, -221, -209, -182, -132, -68, -26, -12, 27,
                      160, 315, 402, 432, 517, 713, 972, 1123, 1114, 1089, 1261, 1513, 1611, 1554,
                      1527, 1644, 1893, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
                      2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
                      2047, 2047, 2047, 2047, 2047, 2006, 1906, 1820, 1770, 1735, 1675, 1581, 1483,
                      1451, 1445, 1396, 1316, 1249, 1210, 1192, 1155, 1075, 967, 915, 920, 892, 811,
                      726, 680, 690, 698, 646, 538, 464, 499, 518, 457, 359, 304, 314, 357, 337, 231,
                      123, 166, 245, 229, 139, 75, 86, 145, 145, 40, -118, -124, 3, 32, -75, -187,
                      -193, -87, -18, -109, -299, -347, -184, -69, -130, -242, -254, -153, -40, -66,
                      -218, -323, -227, -94, -119, -238, -281, -204, -76, -50, -166, -294, -217, -51,
                      -7, -109, -194, -161, -43, 12, -74, -236, -235, -58, 18, -92, -214,-203, -75,
                      35, 23, -94, -135, 24, 169, 165, 118, 139, 247, 357, 356, 247, 168, 293, 432,
                      416, 289, 194, 226, 340, 373, 264, 117, 129, 236, 250, 139, 11, -22, 58, 122,
                      35, -158, -225, -94, -12, -93, -221, -263, -178, -66, -85, -242, -347, -247,
                      -140, -181, -269, -300, -275, -184, -150, -262, -396, -326, -180, -173, -297,
                      -377, -357, -246, -177, -244, -375, -342, -162, -85, -166, -269, -276, -166,
                      -54, -76, -212, -225, -50, 73, 42, -33, -45, 21, 102, 73, -43, -121, -8, 131,
                      130, 7, -55, 2, 131, 165, 24, -161, -130, 48, 101, -25, -131, -121, -9, 67,
                      -7, -170, -193, -37, 36, -68, -186, -202, -119, -34, -91, -277, -359, -217,
                      -93, -155, -305, -359, -276, -148, -153, -318, -457, -377, -235, -231, -331,
                      -382, -357, -275, -242, -333, -472, -443, -289, -231, -313, -391, -373};

#define PIN_LED_B              GET_PIN(F, 11)      // PF11 :  LED_B        --> LED
#define PIN_LED_R              GET_PIN(F, 12)      // PF12 :  LED_R        --> LED

void thread1_entry(void *parameter)
{
    while(1)
    {
        rt_sem_take(&sem, RT_WAITING_FOREVER);
        rt_pin_write(PIN_LED_R, PIN_LOW);
        rt_thread_mdelay(500);
        rt_pin_write(PIN_LED_R, PIN_HIGH);
        rt_thread_mdelay(500);

    }

}

rt_uint64_t count = 0;

int main(void)
{

    Uart4 =  rt_device_find(SAMPLE_UART_NAME);
    Uart4_config.baud_rate = BAUD_RATE_57600;
    Uart4_config.data_bits = DATA_BITS_8;
    Uart4_config.stop_bits = STOP_BITS_1;
    Uart4_config.parity = PARITY_NONE;
    Uart4_config.bufsz     = 512;
    rt_device_control(Uart4, RT_DEVICE_CTRL_CONFIG,(void*)&Uart4_config);
    rt_device_open(Uart4, RT_DEVICE_OFLAG_RDWR | RT_DEVICE_FLAG_INT_TX );
    rt_pin_mode(PIN_LED_R, PIN_MODE_OUTPUT);

    rt_sem_init(&sem, "rx_sem", 0, RT_IPC_FLAG_FIFO);
    thread1 = rt_thread_create("LED",thread1_entry,RT_NULL,1024,15,5);
    rt_thread_startup(thread1);
    rt_uint8_t i=0;
    while (1)
    {
        count++;
        i++;
        i%=sizeof(data)/sizeof(data[0]);
        if(count == 100)
        {
            count = 0;
            rt_sem_release(&sem);
        }
        rt_thread_mdelay(1);
        rt_device_write(Uart4, 0, send_data,1);
        rt_device_write(Uart4, 0, send_data,1);
        rt_device_write(Uart4, 0, send_data_1,1);
        rt_device_write(Uart4, 0, send_data_2,1);
        rt_device_write(Uart4, 0, send_data_3,1);
        send_data_4 = (data[i]>>8);
        send_data_5 = data[i];
        rt_device_write(Uart4, 0, &send_data_4,1);
        rt_device_write(Uart4, 0, &send_data_5,1);

        rt_uint32_t che= ((0x80 + 0x02 + send_data_4 +send_data_5)^0xFFFFFFFF)&0xff;
        rt_device_write(Uart4, 0, &che,1);

    }

    return RT_EOK;
}
